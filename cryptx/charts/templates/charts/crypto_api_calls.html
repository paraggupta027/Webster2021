<script>
   

let coin_symbol = "{{coin.symbol}}";
let coin_name = "{{coin.name}}";


let real_time_url = "https://min-api.cryptocompare.com/data/price?fsym=" +  coin_symbol  +"&tsyms=USD";
let currency_name = "USD";
let time_stamp = Math.round(new Date().getTime() / 1000);


let history_url = "https://min-api.cryptocompare.com/data/v2/histominute?fsym=" +
    coin_name + "&tsym=" + currency_name + "&limit=2000" + "&toTs=" + time_stamp;
console.log(time_stamp)

let all_candles = [];

let reset = 0;
let chart;
let lineSeries;


$(document).ready(
    function() {

        var rateP = document.getElementById('rate');

        chart = LightweightCharts.createChart(document.getElementById('mychart'), {

        });
        lineSeries = chart.addLineSeries({
            drawCrosshairMarker: true,
            lineWidth: 2,
            color: 'black',
        });


        chart.applyOptions({
            title: 'DOGE',
            priceScale: {
                position: 'right',
                mode: 0,
                // autoScale: false,
                // invertScale: true,
                // alignLabels: true,
                borderVisible: true,
                borderColor: 'black',
                scaleMargins: {
                    top: 0.30,
                    bottom: 0.25,
                },
            },
            timeScale: {
                rightOffset: 12,
                barSpacing: 3,
                // fixLeftEdge: true,
                lockVisibleTimeRangeOnResize: true,
                rightBarStaysOnScroll: true,
                borderVisible: true,
                borderColor: 'black',
                visible: true,
                timeVisible: true,
                secondsVisible: false,
                tickMarkFormatter: (time, tickMarkType, locale) => {
                    console.log(time, tickMarkType, locale);
                    let date = new Date(time * 1000);
                    const year = date.getHours() + ":" + date.getMinutes();
                    return String(year);
                },
            },

            // timeScale: {
            //     rightOffset: 50,
            //     tickMarkFormatter: (time, tickMarkType, locale) => {
            // let date = new Date(time * 1000);
            // const year = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
            //         // console.log(year);

            //         return String(year);
            //     },
            // },
            crosshair: {
                vertLine: {
                    color: 'Black',
                    width: 1.7,
                    style: 1,
                    visible: true,
                    labelVisible: true,
                },
                horzLine: {
                    color: 'Black',
                    width: 1.7,
                    style: 1,
                    visible: true,
                    labelVisible: true,
                },
                mode: 0,
            },
        });
        var k = 2;
        async function add_history() {
            const response = await fetch(history_url);
            var dataRes = await response.json();
            var data = dataRes.Data.Data;
            // if(data)
            // data.reverse();
            // k--;
            // if(k==0)clearInterval(interval)
            if (data)
                for (let i = 0; i < data.length; i++) {
                    let candle = data[i];
                    var newDate = new Date();
                    var curtime = candle.time;
                    let newCandle = { time: curtime, value: candle.close };
                    all_candles.push(newCandle);
                    // console.log(all_candles.slice(-1));
                    // lineSeries.setData(all_candles);
                    // lineSeries.setData(newCandle)
                    // take++;
                }
            console.log(all_candles.length)
            console.log(time_stamp);
            time_stamp -= 2000 * 60;
            history_url = "https://min-api.cryptocompare.com/data/v2/histominute?fsym=" +
                coin_name + "&tsym=" + currency_name + "&limit=2000" + "&toTs=" + time_stamp;
            // console.log();

            //  all_candles.push(newCandle);
            console.log(all_candles);


        }
        
        setInterval(() => {
            addPoint();
        }, 3000);

    });





async function addPoint() {

    const response = await fetch(real_time_url);
    let data = await response.json();

    // console.log(data.USD,all_candles.length);

    let newDate = new Date();
    let curtime = newDate.getTime() / 1000;
    let newCandle = { time: curtime, value: data.USD };

    let new_price = data.USD;

    if(all_candles.length){
        const last_candle = all_candles[all_candles.length-1];
        const last_time  = new Date(last_candle.time*1000)

        let last_price = last_candle.value;
        let cur_price = newCandle.value;

        changePrice(last_price,cur_price);

        if(last_time.getMinutes()!=newDate.getMinutes()){
            all_candles.push(newCandle);
        }
        else{
            all_candles[all_candles.length-1] = newCandle;
        }
    }
    else{
        all_candles.push(newCandle);
    }
    lineSeries.setData(all_candles);
}

function changePrice(last_price,cur_price)
{
    let price=document.getElementById("id_real_time_price");
    let diff = cur_price-last_price;
    diff=diff.toFixed(3);

    if(last_price<=cur_price)
    {
        price.innerHTML=cur_price+"$ " +"(+"+ diff+ ")";
        price.style.color="green";
    }
    else
    {
        price.innerHTML=cur_price+"$ " +"("+diff+")";
        price.style.color="red";
    }
}


</script>